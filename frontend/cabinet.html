<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; margin:0; padding: 15px; }
        .card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; }
        .status { font-size: 12px; padding: 4px 8px; border-radius: 8px; background: #dcfce7; color: #166534; }
        .row { font-size: 14px; color: #4b5563; margin-bottom: 5px; }
        .actions { display: flex; gap: 8px; margin-top: 15px; }
        .btn { padding: 8px; border-radius: 8px; border: none; font-size: 13px; cursor: pointer; text-align: center; }
        .btn-share { background: #3b82f6; color: white; flex: 1; }
        .btn-excel { background: #22c55e; color: white; flex: 1; }
        .btn-delete { background: #fee2e2; color: #ef4444; width: 40px; display: flex; align-items: center; justify-content: center; }
        .empty { text-align: center; color: #9ca3af; margin-top: 50px; }
    </style>
</head>
<body>
    <h2 style="margin-top:0">üóÇ –ú–æ–∏ –∫–∞–º–ø–∞–Ω–∏–∏</h2>
    <div id="list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <button onclick="window.location.href='/index.html'" style="width:100%; padding:15px; margin-top:20px; border:none; background:#e5e7eb; border-radius:12px;">‚óÄÔ∏è –ù–∞–∑–∞–¥</button>

    <script>
        let tg = window.Telegram.WebApp;
        if(tg) tg.ready();

        // –§–æ–ª–ª–±—ç–∫ ID –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –∏–Ω–∞—á–µ —Ä–µ–∞–ª—å–Ω—ã–π ID –∏–∑ Telegram
        const userId = tg.initDataUnsafe?.user?.id || 174046571;

        function loadCampaigns() {
            fetch(`/api/user-campaigns/${userId}`)
                .then(r => r.json())
                .then(data => {
                    const list = document.getElementById('list');
                    list.innerHTML = '';
                    
                    if(!data.campaigns || data.campaigns.length === 0) {
                        list.innerHTML = '<div class="empty">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫</div>';
                        return;
                    }

                    data.campaigns.forEach(c => {
                        const div = document.createElement('div');
                        div.className = 'card';
                        div.innerHTML = `
                            <div class="header">
                                <span>#${c.campaign_number}</span>
                                <span class="status">–ê–ö–¢–ò–í–ù–ê</span>
                            </div>
                            <div class="row">üí∞ ${formatNum(c.final_price)} ‚ÇΩ</div>
                            <div class="row">üìÖ ${formatDate(c.start_date)} - ${formatDate(c.end_date)}</div>
                            <div class="actions">
                                <button class="btn btn-share" onclick="share('${c.campaign_number}', ${c.final_price}, ${c.actual_reach})">üì§</button>
                                <button class="btn btn-excel" onclick="sendExcel('${c.campaign_number}')">Excel</button>
                                <button class="btn btn-delete" onclick="deleteCampaign('${c.campaign_number}')">üóëÔ∏è</button>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                });
        }

        loadCampaigns();

        function formatNum(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " "); }
        function formatDate(d) { return new Date(d).toLocaleDateString('ru-RU'); }

        function share(num, price, reach) {
            const text = `üìä –ö–∞–º–ø–∞–Ω–∏—è #${num}\nüí∞ ${formatNum(price)} ‚ÇΩ\nüë• –û—Ö–≤–∞—Ç: ~${formatNum(reach)}`;
            const url = `https://t.me/share/url?url=${encodeURIComponent('https://t.me/yaradiobot')}&text=${encodeURIComponent(text)}`;
            
            if (tg && tg.openTelegramLink) tg.openTelegramLink(url);
            else window.open(url, '_blank');
        }

        function sendExcel(num) {
            if (!tg.initData && userId === 174046571) {
                 // –ï—Å–ª–∏ –º—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–µ–º –û–ö (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)
                 alert('–í –±—Ä–∞—É–∑–µ—Ä–µ Excel –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, –Ω–æ –∑–∞–ø—Ä–æ—Å –∏–¥–µ—Ç.');
            }
            
            fetch(`/api/send-excel/${num}`, {
                 method: 'POST',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify({user_telegram_id: userId})
             }).then(r => r.json()).then(d => {
                 if(d.success) alert('‚úÖ Excel –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç!');
                 else alert('‚ùå –û—à–∏–±–∫–∞: ' + d.error);
             });
        }

        function deleteCampaign(num) {
            if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞–º–ø–∞–Ω–∏—é?')) return;
            
            fetch(`/api/delete-campaign/${num}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(d => {
                    if(d.success) {
                        alert('üóëÔ∏è –ö–∞–º–ø–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–∞');
                        loadCampaigns();
                    } else {
                        alert('‚ùå ' + d.error);
                    }
                });
        }
    </script>
</body>
</html>

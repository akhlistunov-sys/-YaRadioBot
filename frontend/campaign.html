<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f8f9fa; min-height: 100vh; }
        .container { max-width: 480px; margin: 0 auto; background: white; min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: white; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .step-content { display: none; }
        .step-content.active { display: block; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; background: #3b82f6; color: white; font-weight: 600; margin: 5px 0; cursor: pointer; }
        .btn-secondary { background: #e9ecef; color: #495057; }
        .radio-station { padding: 15px; border: 2px solid #e9ecef; border-radius: 12px; margin-bottom: 10px; cursor: pointer; }
        .radio-station.selected { border-color: #3b82f6; background: #eff6ff; }
        .form-input { width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 12px; margin-bottom: 10px; font-size: 16px; }
        .stat-item { display: flex; justify-content: space-between; margin: 10px 0; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h3>üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏</h3>
        </div>
        <div class="content">
            <!-- Steps -->
            <div id="step1" class="step-content active">
                <h4>üìª –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–¥–∏–æ—Å—Ç–∞–Ω—Ü–∏–∏</h4>
                <div id="radioList"></div>
                <button class="btn" onclick="nextStep(2)">–î–∞–ª–µ–µ</button>
            </div>

            <div id="step2" class="step-content">
                <h4>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã</h4>
                <input type="date" id="startDate" class="form-input">
                <input type="date" id="endDate" class="form-input">
                <button class="btn btn-secondary" onclick="prevStep(1)">–ù–∞–∑–∞–¥</button>
                <button class="btn" onclick="nextStep(3)">–î–∞–ª–µ–µ</button>
            </div>

            <div id="step3" class="step-content">
                <h4>‚è∞ –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</h4>
                <div id="timeList"></div>
                <button class="btn btn-secondary" onclick="prevStep(2)">–ù–∞–∑–∞–¥</button>
                <button class="btn" onclick="nextStep(4)">–î–∞–ª–µ–µ</button>
            </div>

            <div id="step4" class="step-content">
                <h4>üéôÔ∏è –†–æ–ª–∏–∫</h4>
                <button class="btn" onclick="setPath('text'); nextStep(5)">–í–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç</button>
                <button class="btn" onclick="setPath('audio'); nextStep(6)">–ü—Ä–∏—Å–ª–∞—Ç—å –∞—É–¥–∏–æ</button>
                <button class="btn btn-secondary" onclick="prevStep(3)">–ù–∞–∑–∞–¥</button>
            </div>

            <div id="step5" class="step-content">
                <h4>üìù –¢–µ–∫—Å—Ç —Ä–æ–ª–∏–∫–∞</h4>
                <textarea id="campaignText" class="form-input" rows="5"></textarea>
                <button class="btn btn-secondary" onclick="prevStep(4)">–ù–∞–∑–∞–¥</button>
                <button class="btn" onclick="nextStep(7)">–î–∞–ª–µ–µ</button>
            </div>

            <div id="step6" class="step-content">
                <h4>‚è±Ô∏è –•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂</h4>
                <input type="number" id="duration" class="form-input" value="20">
                <button class="btn btn-secondary" onclick="prevStep(4)">–ù–∞–∑–∞–¥</button>
                <button class="btn" onclick="nextStep(8)">–î–∞–ª–µ–µ</button>
            </div>

            <div id="step7" class="step-content">
                <h4>üé¨ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h4>
                <div class="radio-station" onclick="setProd('standard'); nextStep(8)">–°—Ç–∞–Ω–¥–∞—Ä—Ç (2000‚ÇΩ)</div>
                <div class="radio-station" onclick="setProd('premium'); nextStep(8)">–ü—Ä–µ–º–∏—É–º (5000‚ÇΩ)</div>
            </div>

            <div id="step8" class="step-content">
                <h4>üë§ –ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
                <input type="text" id="name" placeholder="–ò–º—è" class="form-input">
                <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" class="form-input">
                <input type="email" id="email" placeholder="Email" class="form-input">
                <input type="text" id="company" placeholder="–ö–æ–º–ø–∞–Ω–∏—è" class="form-input">
                <button class="btn btn-secondary" onclick="prevStep(7)">–ù–∞–∑–∞–¥</button>
                <button class="btn" onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            </div>

            <div id="step9" class="step-content">
                <h4>üéØ –ò—Ç–æ–≥</h4>
                <div id="results"></div>
                <button class="btn btn-secondary" onclick="prevStep(8)">–ù–∞–∑–∞–¥</button>
                <button class="btn" onclick="submit()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
            </div>
        </div>
    </div>

    <script>
        let state = {
            radios: [], slots: [], start:'', end:'', days:0, text:'', dur:20, prod:'',
            name:'', phone:'', email:'', comp:'', calculation:null
        };

        const stations = ["LOVE RADIO", "–ê–í–¢–û–†–ê–î–ò–û", "–†–ê–î–ò–û –î–ê–ß–ê", "–†–ê–î–ò–û –®–ê–ù–°–û–ù", "–†–ï–¢–†–û FM", "–Æ–ú–û–† FM"];
        
        function renderRadios() {
            let h = '';
            stations.forEach(s => {
                h += `<div class="radio-station ${state.radios.includes(s)?'selected':''}" onclick="toggleRadio('${s}')">${s}</div>`;
            });
            document.getElementById('radioList').innerHTML = h;
        }

        function toggleRadio(s) {
            if(state.radios.includes(s)) state.radios = state.radios.filter(x=>x!==s);
            else state.radios.push(s);
            renderRadios();
        }

        function renderSlots() {
             fetch('/api/time-slots').then(r=>r.json()).then(d=>{
                 let h = '';
                 d.time_slots.forEach((s,i) => {
                     h += `<div class="radio-station ${state.slots.includes(i)?'selected':''}" onclick="toggleSlot(${i})">${s.time} - ${s.label}</div>`;
                 });
                 document.getElementById('timeList').innerHTML = h;
             });
        }

        function toggleSlot(i) {
            if(state.slots.includes(i)) state.slots = state.slots.filter(x=>x!==i);
            else state.slots.push(i);
            renderSlots();
        }

        function nextStep(n) {
            document.querySelectorAll('.step-content').forEach(d=>d.classList.remove('active'));
            document.getElementById('step'+n).classList.add('active');
            if(n===1) renderRadios();
            if(n===3) renderSlots();
        }
        function prevStep(n) { nextStep(n); }
        function setPath(p) { state.path = p; }
        function setProd(p) { state.prod = p; }

        function calculate() {
            state.name = document.getElementById('name').value;
            state.phone = document.getElementById('phone').value;
            state.email = document.getElementById('email').value;
            state.comp = document.getElementById('company').value;
            state.start = document.getElementById('startDate').value;
            state.end = document.getElementById('endDate').value;
            state.text = document.getElementById('campaignText').value;
            state.dur = parseInt(document.getElementById('duration').value);

            // Calc days
            const d1 = new Date(state.start);
            const d2 = new Date(state.end);
            state.days = Math.ceil((d2-d1)/(1000*60*60*24)) + 1;

            fetch('/api/calculate', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    selected_radios: state.radios,
                    selected_time_slots: state.slots,
                    campaign_days: state.days,
                    duration: state.dur,
                    production_option: state.prod
                })
            }).then(r=>r.json()).then(d=>{
                state.calculation = d.calculation;
                let h = `
                    <div class="stat-item"><span>–¶–µ–Ω–∞:</span><b>${d.calculation.final_price} ‚ÇΩ</b></div>
                    <div class="stat-item"><span>–û—Ö–≤–∞—Ç:</span><b>~${d.calculation.total_reach}</b></div>
                    <div class="stat-item"><span>–¶–µ–Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞:</span><b>${d.calculation.cost_per_contact} ‚ÇΩ</b></div>
                `;
                document.getElementById('results').innerHTML = h;
                nextStep(9);
            });
        }

        function submit() {
            fetch('/api/create-campaign', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    user_id: 174046571, // HARDCODED ADMIN ID
                    selected_radios: state.radios,
                    selected_time_slots: state.slots,
                    start_date: state.start,
                    end_date: state.end,
                    campaign_days: state.days,
                    campaign_text: state.text,
                    production_option: state.prod,
                    contact_name: state.name,
                    phone: state.phone,
                    email: state.email,
                    company: state.comp,
                    duration: state.dur
                })
            }).then(r=>r.json()).then(d=>{
                if(d.success) window.location.href = `/confirmation.html?campaign=${d.campaign_number}`;
                else alert(d.error);
            });
        }
        
        renderRadios();
    </script>
</body>
</html>

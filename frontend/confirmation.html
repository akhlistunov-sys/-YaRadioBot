<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; margin:0; }
        .container { max-width: 480px; margin: 0 auto; background: white; min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: #22c55e; color: white; padding: 30px 20px; text-align: center; border-radius: 0 0 24px 24px; }
        .content { padding: 20px; flex: 1; }
        .card { background: #f8f9fa; border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        .label { color: #6c757d; }
        .value { font-weight: 600; color: #212529; }
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 600; font-size: 15px; margin-bottom: 10px; cursor: pointer; }
        .btn-share { background: #3b82f6; color: white; }
        .btn-excel { background: #10b981; color: white; }
        .btn-home { background: transparent; border: 2px solid #e9ecef; color: #495057; }
        .btn-cabinet { background: #6b7280; color: white; }
        .btn-new { background: #f59e0b; color: white; }
        .loading { text-align: center; padding: 40px; }
        .success-icon { font-size: 40px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        
        <div id="successView" style="display:none">
            <div class="header">
                <div class="success-icon">üéâ</div>
                <h1 style="margin:0; font-size: 24px;">–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!</h1>
                <div id="campaignNumber" style="margin-top: 5px; opacity: 0.9;">#R-...</div>
            </div>
            
            <div class="content">
                <div class="card">
                    <div class="row">
                        <span class="label">–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                        <span class="value" id="price">0 ‚ÇΩ</span>
                    </div>
                    <div class="row">
                        <span class="label">–û—Ö–≤–∞—Ç:</span>
                        <span class="value" id="reach">~0</span>
                    </div>
                    <div class="row">
                        <span class="label">–¶–µ–Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞:</span>
                        <span class="value" style="color: #22c55e" id="cpc">0.00 ‚ÇΩ</span>
                    </div>
                </div>
                
                <div style="background: #e0f2fe; padding: 15px; border-radius: 12px; margin-bottom: 20px; font-size: 13px; color: #0369a1;">
                    üìû <b>–ß–¢–û –î–ê–õ–¨–®–ï?</b><br>
                    1. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤<br>
                    2. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏–º –¥–µ—Ç–∞–ª–∏ –∏ –∑–∞–ø—É—Å—Ç–∏–º —Ä–µ–∫–ª–∞–º—É
                </div>
                
                <button class="btn btn-share" onclick="shareWithBoss()">
                    üì§ –ü–û–î–ï–õ–ò–¢–¨–°–Ø
                </button>
                
                <button class="btn btn-excel" onclick="sendExcel()">
                    üì• –û–¢–ü–†–ê–í–ò–¢–¨ EXCEL –í TELEGRAM
                </button>
                
                <button class="btn btn-cabinet" onclick="window.location.href='/cabinet.html'">
                    üìã –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢
                </button>
                
                <button class="btn btn-new" onclick="window.location.href='/campaign.html'">
                    üöÄ –ù–û–í–ê–Ø –ö–ê–ú–ü–ê–ù–ò–Ø
                </button>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        if(tg) tg.ready();
        
        let campaignData = {};

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('campaign');

        fetch(`/api/confirmation/${id}`)
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    campaignData = data.campaign;
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('successView').style.display = 'block';
                    
                    document.getElementById('campaignNumber').innerText = '#' + campaignData.campaign_number;
                    document.getElementById('price').innerText = formatNum(campaignData.final_price) + ' ‚ÇΩ';
                    document.getElementById('reach').innerText = '~' + formatNum(campaignData.actual_reach);
                    document.getElementById('cpc').innerText = campaignData.cost_per_contact + ' ‚ÇΩ';
                }
            });

        function formatNum(n) {
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        function shareWithBoss() {
            const text = `üìä *–û—Ç—á–µ—Ç –ø–æ —Ä–µ–∫–ª–∞–º–µ #${campaignData.campaign_number}*\n\n` +
                         `üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${formatNum(campaignData.final_price)} ‚ÇΩ\n` +
                         `üë• –û—Ö–≤–∞—Ç: ~${formatNum(campaignData.actual_reach)} —á–µ–ª.\n` +
                         `üéØ –¶–µ–Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞: ${campaignData.cost_per_contact} ‚ÇΩ\n` +
                         `üìÖ –ü–µ—Ä–∏–æ–¥: ${formatDate(campaignData.start_date)} - ${formatDate(campaignData.end_date)}\n\n` +
                         `–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ –†–∞–¥–∏–æ –¢–û`;
            
            const url = `https://t.me/share/url?url=${encodeURIComponent('https://t.me/yaradiobot')}&text=${encodeURIComponent(text)}`;
            
            if (tg && tg.openTelegramLink) {
                tg.openTelegramLink(url);
            } else {
                window.open(url, '_blank');
            }
        }
        
        function formatDate(d) {
            if(!d) return '';
            return new Date(d).toLocaleDateString('ru-RU');
        }

        function sendExcel() {
             // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ ID —Å —Ñ–æ–ª–ª–±—ç–∫–æ–º –Ω–∞ –∞–¥–º–∏–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
             let userId = tg?.initDataUnsafe?.user?.id;
             
             // –ï—Å–ª–∏ ID –Ω–µ—Ç (–æ—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ), –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ localStorage –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É
             if (!userId) {
                 // –î–ª—è —Ç–µ—Å—Ç–æ–≤ –∞–¥–º–∏–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                 userId = 174046571; 
                 // –ù–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –≤—ã–≤–æ–¥–∏–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ Telegram
                 if (!tg.initData) {
                     alert('‚ö†Ô∏è –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram!');
                     return;
                 }
             }

             fetch(`/api/send-excel/${campaignData.campaign_number}`, {
                 method: 'POST',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify({user_telegram_id: userId})
             }).then(r => r.json()).then(d => {
                 if(d.success) alert('‚úÖ Excel —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–∞–º –≤ —á–∞—Ç!');
                 else alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + d.error);
             }).catch(e => {
                 alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
             });
        }
    </script>
</body>
</html>
